$vmName = "Test Build HKTC"
$screenshotPath = "C:\Desktop"
$hyperVServer = "blade5.btrusteng.com"

# Establish a remote PowerShell session to the Hyper-V server
$session = New-PSSession -ComputerName $hyperVServer

# Take a screenshot of the virtual machine
Invoke-Command -Session $session -ScriptBlock {
    param($vmName, $screenshotPath)

    # Get the virtual machine
    $vm = Get-VM -Name $vmName

    # Take the screenshot
    $vm | Get-VMVideo | Set-VMVideo -ResolutionWidth 1024 -ResolutionHeight 768
    $vm | Get-VMVideo | Get-VMRemoteFx3dVideoAdapter | Update-VMRemoteFx3dVideoAdapter -MaximumResolutionWidth 1024 -MaximumResolutionHeight 768

    # Save the screenshot
    $vm | Get-VMVideo | Get-VMRemoteFx3dVideoAdapter | Out-VMVideo -DestinationPath $screenshotPath
} -ArgumentList $vmName, $screenshotPath

# Close the remote PowerShell session
Remove-PSSession $session

